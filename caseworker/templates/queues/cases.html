{% extends 'layouts/base.html' %}

{% load svg static %}

{% block back_link %}{% endblock %}

{% block title %}
	{{ queue.name }}
{% endblock %}

{% block messages %}
	{{ block.super }}
	{% if queue.id != updated_cases_banner_queue_id and show_updated_cases_banner %}
		<a id="banner-exporter-amendments" class="app-hidden govuk-width-container app-snackbar app-snackbar--no-animation" href="{% url 'queues:cases' updated_cases_banner_queue_id %}">
			<div class="app-snackbar__content">
				<div class="app-snackbar__icon"></div>
				{% lcs 'cases.CasesListPage.EXPORTER_AMENDMENTS_BANNER' %}
			</div>
		</a>
	{% endif %}
{% endblock %}

{% block body %}
	<div class="lite-app-bar">
		<div class="lite-app-bar__content">
			<h1 class="govuk-heading-l">
				<a tabindex="0" id="link-queue" href="{% url 'queues:manage' %}" class="app-dropdown__heading">
					{{ queue.name }}<span class="govuk-visually-hidden"> (Click to change queue)</span>
				</a>
			</h1>
		</div>
		{% if not queue.is_system_queue %}
			<div class="lite-app-bar__controls lite-buttons-row" >
				<div data-enable-on-checkboxes="#table-cases">
					<button id="assign-users-button" form="form-cases" type="submit" class="govuk-button govuk-button--secondary">{% lcs 'cases.CasesListPage.ASSIGN_USERS' %}</button>
				</div>
				{% if enforcement_check %}
					{% govuk_link_button id='export-xml' classes='govuk-button--secondary' text='cases.CasesListPage.EnforcementXML.EXPORT_BUTTON' url='queues:enforcement_xml_export' url_param=queue.id %}
					{% govuk_link_button id='import-xml' classes='govuk-button--secondary' text='cases.CasesListPage.EnforcementXML.IMPORT_BUTTON' url='queues:enforcement_xml_import' url_param=queue.id %}
				{% endif %}
			</div>
		{% endif %}
	</div>

	<div id="queues" class="app-hidden">
		<div class="app-menu__search">
			<div>
				{% svg 'search' %}
			</div>
			<input type="text" id="filter-queues">
		</div>
		{% for item in cases.results.queues %}
			<a href="{% url 'queues:cases' item.id %}" id="{{ item.id }}" class="app-menu__item app-menu__item--subtitle {% if item.id == queue.id %}app-menu__item--selected{% endif %}">
				{{ item.name }}
				<span class="app-menu__item-subtitle">{{ item.case_count }}</span>
			</a>
		{% endfor %}
	</div>

	<p class="lite-filters__hint-text">{{ cases.count }} case{{ cases.count|pluralize }}</p>

	{% include 'filters.html' %}

	<form id="form-cases" method="get" action="{% url 'queues:case_assignments' queue.id %}">
		{% if not cases.results %}
			{% include "includes/notice.html" with text='cases.CasesListPage.NO_CASES' %}
		{% else %}
		<table id="table-cases" class="govuk-table">
			<thead class="govuk-table__head">
				<tr class="govuk-table__row">
					{% if not queue.is_system_queue %}
						<th class="govuk-table__header govuk-table__cell--checkbox">
							<button id="button-select-all" type="button" name="button" class="lite-button-checkbox" title="Select all/Deselect all"></button>
						</th>
					{% endif %}
					<th class="govuk-table__header govuk-table__cell--tight" scope="col"><span class="govuk-visually-hidden">{% lcs 'cases.CasesListPage.Table.SLA' %}</span></th>
					<th class="govuk-table__header app-table__header--skeleton" scope="col">{% lcs 'cases.CasesListPage.Table.CASE' %}</th>
					<th class="govuk-table__header app-table__header--skeleton" scope="col">{% lcs 'cases.CasesListPage.Table.ASSIGNEES' %}</th>
					<th class="govuk-table__header app-table__header--skeleton lite-tablet-hide" width="15%" scope="col">Flags</th>
					<th class="govuk-table__header app-table__header--skeleton lite-tablet-hide" width="15%" scope="col">{% lcs 'cases.CasesListPage.Table.GOODS' %}</th>
					<th class="govuk-table__header app-table__header--skeleton lite-tablet-hide" width="15%" scope="col">{% lcs 'cases.CasesListPage.Table.DESTINATIONS' %}</th>
				</tr>
			</thead>

			<tbody class="govuk-table__body" id="tbody-main">
				{% for case in cases.results.cases %}
					{% include 'includes/case-row.html' with case=case %}
				{% endfor %}
			</tbody>
		</table>
		{% endif %}
	</form>

{% endblock %}

{% block javascript %}
<div class="app-hidden--force" id="js-chevron-svg">
	{% svg 'chevron' %}
</div>

	<script src="{% static 'javascripts/cases.js' %}"></script>

	<script nonce="{{ request.csp_nonce }}">
		var params = `{{ params }}`;
		var previousSVG = `{% svg 'previous' %}`;
		var nextSVG = `{% svg 'next' %}`;
		var chevron = `{% svg 'chevron' %}`;
		var noCases = `{% include "includes/notice.html" with text='cases.CasesListPage.NO_CASES' %}`;

		var data = {{ cases_json|safe }};

			if (data.total_pages > 1) {
				generatePagination({{ request.GET.page|default:1 }}, data.total_pages);
			}

			$.each(data.results.filters.statuses, function(i, item) {
				$("#status").append(`<option value="${item.key}" ${(item.key == "{{ case_officer }}" ? "selected" : "")}>${item.value}</option>`)
			});
			$.each(data.results.filters.case_types, function(i, item) {
				$("#case_type").append(`<option value="${item.key}" ${(item.key == "{{ case_type }}" ? "selected" : "")}>${item.value}</option>`)
			});
			$.each(data.results.filters.gov_users, function(i, item) {
				$("#case_officer").append(`<option value="${item.id}" ${(item.id == "{{ case_officer }}" ? "selected" : "")}>${item.full_name}</option>`)
				$("#assigned_user").append(`<option value="${item.id}" ${(item.id == "{{ assigned_user }}" ? "selected" : "")}>${item.full_name}</option>`)
			});
			$.each(data.results.filters.advice_types, function(i, item) {
				$("#team_advice_type").append(`<option value="${item.key}" ${(item.key == "{{ team_advice_type }}" ? "selected" : "")}>${item.value}</option>`)
				$("#final_advice_type").append(`<option value="${item.key}" ${(item.key == "{{ final_advice_type }}" ? "selected" : "")}>${item.value}</option>`)
			});

			loadAutoCompletes();
			tryShowFilterBar();

	</script>
{% endblock %}
